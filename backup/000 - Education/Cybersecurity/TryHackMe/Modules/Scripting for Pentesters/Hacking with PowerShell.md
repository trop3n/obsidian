
## What is PowerShell?

PowerShell is the Windows Scripting Language and shell environment built using the .NET Framework.

This also allows Powershell to execute .NET functions directly from it's Shell. Most PowerShell commands, called cmdlets, are written in .NET.  Unlike other scripting languages and shell environments, the output of these cmdlets are *objects* - making PowerShell somewhat object oriented.

This also means that running cmdlets allows you to perform actions on the output object (which makes it convenient to pass output from one *cmdlet* to another.) The normal format of a *cmdlet* is represented using *Verb-Noun*; for example, the *cmdlet* to list commands is called `Get-Command`.

Common verbs to use include:

- Get
- Start
- Stop
- Read
- Write
- New
- Out

To get the complete list of approved verbs, visit [this](https://docs.microsoft.com/en-us/powershell/scripting/developer/cmdlet/approved-verbs-for-windows-powershell-commands?view=powershell-7) link

## Basic PowerShell Commands

Now that  we understand how *cmdlets* work, let's explore how to use them. The main thing to remember is that `Get-Command` and `Get-Help` are your best friends.

### Using `Get-Help`

`Get-Help` displays information about a `cmdlet`. To get help with a particular command, run the following:

`Get-Help Command-Name`

You can also understand how exactly to use the command by passing in the `-examples` flag. This would return the output like the following:

```powershell
PS C:\Users\Administrator> Get-Help Get-Command -Examples 

NAME    
Get-Command

SYNOPSIS 
Gets all commands.  

Example 1: Get cmdlets, functions, and aliases  

PS C:\>Get-Command
```

### Using `Get-Command`

`Get-Command` gets all the `cmdlets` installed on the current computer. The great thing about this *cmdlet* is that it allows for pattern matching.

`Get-Command Verb-*` or `Get-Command Noun-*`

Running `Get-Command New-*` lets you view all the *cmdlets* for the verb new displaying the following:

```powershell   
PS C:\Users\Administrator> Get-Command New-*

CommandType     Name                                               Version    Source
-----------     ----                                               -------    ------
Alias           New-AWSCredentials                                 3.3.563.1  AWSPowerShell
Alias           New-EC2FlowLogs                                    3.3.563.1  AWSPowerShell
Alias           New-EC2Hosts                                       3.3.563.1  AWSPowerShell
Alias           New-RSTags                                         3.3.563.1  AWSPowerShell
Alias           New-SGTapes                                        3.3.563.1  AWSPowerShell
Function        New-AutologgerConfig                               1.0.0.0    EventTracingManagement
Function        New-DAEntryPointTableItem                          1.0.0.0    DirectAccessClientComponents
Function        New-DscChecksum                                    1.1        PSDesiredStateConfiguration
Function        New-EapConfiguration                               2.0.0.0    VpnClient
Function        New-EtwTraceSession                                1.0.0.0    EventTracingManagement
Function        New-FileShare                                      2.0.0.0    Storage
Function        New-Fixture                                        3.4.0      Pester
Function        New-Guid                                           3.1.0.0    Microsoft.PowerShell.Utility
--cropped for brevity--

        
```

### Object Manipulation

In the previous task, we saw how the output of every *cmdlet* is an object. If we want to manipulate the host, we need to figure out a few things:

- passing the output to other cmdlets
- using specific object cmdlets to extract information

The ***Pipeline*** (`|`) is used to pass output from one *cmdlet* to another. A major difference compared to other shells is that PowerShell passes an object to the next cmdlet instead of passing text or string to the command after the pipe. 

Like every object in object-oriented frameworks, an object *will contain methods and properties*.

You can think of methods as functions that can be applied to output from the cmdlet, and you can think of properties as variables in the output from a cmdlet. To view these details, pass the output of a cmdlet to the `Get-Member` cmdlet.

`Verb-Noun | Get-Member`

An example of running this to view the members for `Get-Command` is:

`Get-Command | Get-Member -MemberType Method`

```powershell
PS C:\Users\Administrator> Get-Command | Get-Member -MemberType Method


   TypeName: System.Management.Automation.AliasInfo

Name             MemberType Definition
----             ---------- ----------
Equals           Method     bool Equals(System.Object obj)
GetHashCode      Method     int GetHashCode()
GetType          Method     type GetType()
ResolveParameter Method     System.Management.Automation.ParameterMetadata ResolveParameter(string name)
ToString         Method     string ToString()


   TypeName: System.Management.Automation.FunctionInfo

Name             MemberType Definition
----             ---------- ----------
Equals           Method     bool Equals(System.Object obj)
GetHashCode      Method     int GetHashCode()
GetType          Method     type GetType()
ResolveParameter Method     System.Management.Automation.ParameterMetadata ResolveParameter(string name)
ToString         Method     string ToString()


   TypeName: System.Management.Automation.CmdletInfo

Name             MemberType Definition
----             ---------- ----------
Equals           Method     bool Equals(System.Object obj)
GetHashCode      Method     int GetHashCode()
GetType          Method     type GetType()
ResolveParameter Method     System.Management.Automation.ParameterMetadata ResolveParameter(string name)
ToString         Method     string ToString()


PS C:\Users\Administrator>
```

> From the above flag in the command, you can see that you can also select between methods and properties.

### Creating Objects from Previous cmdlets

> One way of manipulating objects is pulling out the properties from the output of a *cmdlet* and creating a new object. 

Here's an example of listing the directories and just selecting the mode and the name:

```powershell
PS C:\Users\Administrator> Get-ChildItem | Select-Object -Property Mode, Name
Mode   Name
----   ----
d-r--- Contacts
d-r--- Desktop
d-r--- Documents
d-r--- Downloads
d-r--- Favorites
d-r--- Links
d-r--- Music
d-r--- Pictures
d-r--- Saved Games
d-r--- Searches
d-r--- Videos

PS C:\Users\Administrator>
```

We can also use the following flags to select particular information:

- `first` - gets the first x object
- `last` - gets the last x object
- `unique` - shows the unique objects
- `skip` - skips x objects

### Filtering Objects

When retrieving output objects, you may want to select objects that match a very specific value. You can do this using the `Where-Object` to filter based on the value of properties.

The general format for using this *cmdlet* is

`Verb-Noun | Where-Object -Property PropertyName -operator Value`
`Verb-Noun | Where-Object {$_.PropertyName -operator Value`

The second versions uses the `$_` operator to iterate through every object passed to the `Where-Object` cmdlet. 

**PowerShell is quite sensitive, so don't put quotes around the command!**

Where `-operator` is a list of the following operators:

- `-Contains`: if any item in the property value is an exact match for the specified value
- `-EQ`: if the property value is the same as the specified value
- `-GT`: if the property value is greater than the specified value

For a full list of operators, use [this](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/where-object?view=powershell-6) link.

Here's an example of checking the stopped processes:

```powershell
PS C:\Users\Administrator> Get-Service | Where-Object -Property Status -eq Stopped  
Status   Name               DisplayName 
------   ----               ----------- 
Stopped  AJRouter           AllJoyn Router Service 
Stopped  ALG                Application Layer Gateway Service 
Stopped  AppIDSvc           Application Identity 
Stopped  AppMgmt            Application Management 
Stopped  AppReadiness       App Readiness 
Stopped  AppVClient         Microsoft App-V Client 
Stopped  AppXSvc            AppX Deployment Service (AppXSVC) 
Stopped  AudioEndpointBu... Windows Audio Endpoint Builder 
Stopped  Audiosrv           Windows Audio 
Stopped  AxInstSV           ActiveX Installer (AxInstSV) 
Stopped  BITS               Background Intelligent Transfer Ser... 
Stopped  Browser            Computer Browser 
Stopped  bthserv            Bluetooth Support Service 
-- cropped for brevity--
```

### Sort-Object

When a cmdlet outputs a lot of information, you may need to sort it to extract the information more efficiently. You do this by pipe-lining the output of a cmdlet to the `Sort-Object` cmdlet.

The format of the command would be:

`Verb-Noun | Sort-Object`

Here's an example of sorting the list of directories:

```powershell
PS C:\Users\Administrator> Get-ChildItem | Sort-Object
    Directory: C:\Users\Administrator
Mode                LastWriteTime         Length Name
----                -------------         ------ ----
d-r---        10/3/2019   5:11 PM                Contacts
d-r---        10/5/2019   2:38 PM                Desktop
d-r---        10/3/2019  10:55 PM                Documents
d-r---        10/3/2019  11:51 PM                Downloads
d-r---        10/3/2019   5:11 PM                Favorites
d-r---        10/3/2019   5:11 PM                Links
d-r---        10/3/2019   5:11 PM                Music
d-r---        10/3/2019   5:11 PM                Pictures
d-r---        10/3/2019   5:11 PM                Saved Games
d-r---        10/3/2019   5:11 PM                Searches
d-r---        10/3/2019   5:11 PM                Videos
PS C:\Users\Administrator>
```

Get-Command | Where-Object -Property CommandType -eq Cmdlet | Measure-Object

## Enumeration

The first step when you have gained initial access to any machine would be to enumerate. We'll be enumerating the following:

- users
- basic network information
- file permissions
- registry permissions
- scheduled and running tasks
- insecure files

## Basic Scripting Challenge

